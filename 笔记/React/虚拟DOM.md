> 从静态页面，到jQuery，在到近几年大火的MVVM框架。研发模式的不断演进的背后是前端对于DOM操作这一核心动作的思考和改进。而虚拟DOM正是MVVM的核心！

### WHAT？

什么是虚拟DOM？

虚拟DOM是JS对象

虚拟DOM是对真实DOM的描述

虚拟DOM本质上是 JS到DOM之间的一个映射缓存（为什么说是缓存？react的更新是对比更新前后，两次render生成的虚拟DOM的差异，将不同的地方体现在真实DOM中。）



### HOW?

##### 在react中，虚拟DOM是如何工作的？

虚拟DOM在React组件的挂载和更新阶段都扮演关键角色。

1. 挂载阶段： React 将结合 JSX 的描述，构建出虚拟 DOM 树，然后通过 ReactDOM.render 实现虚拟 DOM 到真实 DOM 的映射（触发渲染流水线）
2. 更新阶段：页面的变化在作用于真实 DOM 之前，会先作用于虚拟 DOM，虚拟 DOM 将在 JS 层借助算法先对比出具体有哪些真实 DOM 需要被改变，然后再将这些改变作用于真实 DOM；

### WHY?

##### 为什么需要虚拟DOM？

常见回答： DOM操作是很慢的，而JS却可以很快，直接操作DOM会导致频繁的回流和重绘，而JS不存在这些问题。



##### 虚拟DOM的优势是什么？

虚拟DOM在作用于真实DOM之前，对前后两次的差异做了diff，实现了差量更新。相比于传统的DOM节点的替换，使用虚拟DOM在操作真实DOM之前，多了一层缓冲，这个缓冲的好处是，当DOM操作频繁时他会将前后两次的虚拟DOM树进行对比，定位出具体需要更新的部分，生成这样的一份补丁集，最后把这些补丁更新到真实的DOM上。

![](E:\NodeJS-Study\笔记\React\虚拟DOM diff过程.png)

##### React选用虚拟DOM，是为了更好地性能吗？

**虚拟DOM不一定会带来更好地性能，虚拟DOM的优越之处在于，他能在提供更爽更高效的研发模式的同时，任然能保持一个不错的性能。**

关于虚拟DOM的性能问题，我们可以和模板渲染做个对比。

![](E:\NodeJS-Study\笔记\React\模板渲染工作流.png)

![](E:\NodeJS-Study\笔记\React\虚拟DOM渲染工作流.png)

模板渲染过程中的1和虚拟DOM渲染过程中的1和2都是JS操作，由此这两个是可以比较的。

动态生成HTML字符串的过程是对字符串的拼接，对性能的消耗是有限的。

而虚拟DOM的构建和diff过程逻辑相对复杂，不可避免的涉及递归、遍历等耗时操作。由此在JS操作这个层面，模板渲染的性能更优。



模板渲染的步骤3和虚拟DOM的步骤3都是DOM操作范畴的行为。这两个是可以对比的。

模板渲染是全量更新，而虚拟DOM是差量更新。

乍一看好像差量更新一定比全量更新高效。

但是还是要看场景的：

1. 假如，数据内容变化非常大（或者说整个发生了变化），导致差量更新计算出来的结果和全量更新的差不多，在这种情况下，DOM的更新的工作量差不多，而虚拟DOM伴随着开销更大的JS计算。其实这种情况下，虚拟DOM在性能上对比模板渲染就没什么优势了，在极端情况下，甚至不如模板渲染。
2. 如果虚拟DOM和模板渲染在最终的DOM操作量上拉开一点点差距，那么虚拟DOM就有了战胜模板渲染的底气。**因为虚拟DOM的劣势在于JS计算的开销，而JS计算的开销和DOM操作的开销根本不在一个量级上，极少量的DOM操作的性能开销足以支持大量的JS计算**

上面讨论的场景相对比较极端，实际开发中，更加常见的场景是：每次修改少量的状态就触发更新。在这样的场景下，虚拟DOM的优势就体现出来了，因为模板渲染每次都是全量的更新，而虚拟DOM只要更新改变的那一部分DOM就行了。

##### 虚拟DOM的价值不在于性能

虚拟DOM主要解决两个问题：

1. 研发体验/研发效率的问题：这一点前面已经反复强调过，DOM 操作模式的每一次革新，背后都是前端对效率和体验的进一步追求。虚拟 DOM 的出现，为数据驱动视图这一思想提供了高度可用的载体，使得前端开发能够基于函数式 UI 的编程方式实现高效的声明式编程。

2. 跨平台的问题：虚拟 DOM 是对真实渲染内容的一层抽象。若没有这一层抽象，那么视图层将和渲染平台紧密耦合在一起，为了描述同样的视图内容，你可能要分别在 Web 端和 Native 端写完全不同的两套甚至多套代码。但现在中间多了一层描述性的虚拟 DOM，它描述的东西可以是真实 DOM，也可以是iOS 界面、安卓界面、小程序......同一套虚拟 DOM，可以对接不同平台的渲染逻辑，从而实现“一次编码，多端运行”，如下图所示。其实说到底，跨平台也是研发提效的一种手段，它在思想上和1是高度呼应的。

![](E:\NodeJS-Study\笔记\React\虚拟DOM助力跨平台的实现.png)